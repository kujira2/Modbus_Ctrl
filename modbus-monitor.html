<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Modbus RTU 温度モニター</title>
    <link rel="stylesheet" href="js/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
</head>
<body>
    <div class="main-container">
        <div class="control-container">
            <h1>Modbus RTU 温度モニター</h1>
            
            <div class="settings-container">
                <label>
                    更新間隔 (秒):
                    <input type="number" id="updateInterval" value="1" min="1" max="60">
                </label>
                <div style="margin-top: 10px;">
                    <button id="connectButton">接続</button>
                    <button id="applySettings" disabled>設定適用</button>
                </div>
            </div>

            <div class="temperature-control">
                <label>
                    温度設定 (0-60.0℃):
                    <input type="number" id="tempSetpoint" value="25.0" min="0" max="60" step="0.1">
                </label>
                <div style="margin-top: 10px;">
                    <button id="setTemp" disabled>温度設定</button>
                    <button id="return25" disabled>25℃復帰</button>
                </div>
            </div>

            <div class="timer-control">
                <label>
                    タイマー運転時間 (分):
                    <input type="number" id="timerDuration" value="0" min="0" max="5000">
                </label>
                <br>
                <label>
                    タイマー終了時温度 (0-60.0℃):
                    <input type="number" id="timerTemp" value="25.0" min="0" max="60" step="0.1">
                </label>
                <div style="margin-top: 10px;">
                    <button id="startTimer" disabled>タイマー開始</button>
                    <button id="stopTimer" disabled>タイマー停止</button>
                </div>
                <div class="timer-display" id="timerDisplay">残り時間: --:--</div>
            </div>

            <div class="value-display">
                現在温度: <span id="temperatureValue">--.-</span> ℃<br>
                設定温度: <span id="setpointValue">--.-</span> ℃
            </div>
            
            <div class="status" id="statusText"></div>
            <div class="debug-info" id="debugInfo"></div>
        </div>
        <div class="graph-container">
            <canvas id="temperatureChart"></canvas>
        </div>
    </div>

    <script type="module">
        import { ModbusCommands } from './js/modbus-commands.js';
        import { ChartManager } from './js/modbus-chart.js';
        import { TimerManager } from './js/modbus-timer.js';

        let port;
        let keepReading = false;
        let updateIntervalMs = 1000;
        let chartManager;
        let timerManager;

        function showDebugInfo(message, data = null) {
            const debugInfo = document.getElementById('debugInfo');
            let debugText = message;
            if (data) {
                debugText += '\nData: ' + bytesToHex(data);
            }
            debugInfo.textContent = debugText;
        }

        function bytesToHex(bytes) {
            return Array.from(bytes).map(b => b.toString(16).padStart(2, '0').toUpperCase()).join(' ');
        }

        async function readWithTimeout(reader, length, timeout) {
            return new Promise(async (resolve, reject) => {
                const chunks = [];
                let receivedLength = 0;
                const timer = setTimeout(() => {
                    reader.releaseLock();
                    reject(new Error('タイムアウト'));
                }, timeout);

                try {
                    while (receivedLength < length) {
                        const {value, done} = await reader.read();
                        if (done) break;
                        chunks.push(...value);
                        receivedLength += value.length;
                        if (receivedLength >= length) break;
                    }
                    clearTimeout(timer);
                    resolve(new Uint8Array(chunks));
                } catch (error) {
                    clearTimeout(timer);
                    reject(error);
                }
            });
        }

        async function setTemperature(temp) {
            try {
                const command = ModbusCommands.createSetTempCommand(temp);
                const writer = port.writable.getWriter();
                await writer.write(command);
                writer.releaseLock();

                showDebugInfo('温度設定コマンド送信', command);
                document.getElementById('statusText').textContent = 
                    `温度設定完了: ${temp}℃`;
            } catch (error) {
                console.error('温度設定エラー:', error);
                showDebugInfo('温度設定エラー: ' + error.message);
            }
        }

        async function startReading() {
            keepReading = true;
            while (keepReading) {
                try {
                    // 温度読み取り
                    const tempCommand = ModbusCommands.createReadTempCommand();
                    let writer = port.writable.getWriter();
                    await writer.write(tempCommand);
                    writer.releaseLock();

                    let reader = port.readable.getReader();
                    const response = await readWithTimeout(reader, 9, 1000);
                    reader.releaseLock();

                    if (response[0] === 0x0B && response[1] === 0x04 && response[2] === 0x04) {
                        const temp = (response[3] << 8) | response[4];
                        const dp = (response[5] << 8) | response[6];
                        const displayTemp = dp === 1 ? temp / 10 : temp;
                        document.getElementById('temperatureValue').textContent = 
                            displayTemp.toFixed(dp);
                        chartManager.updateChart(displayTemp);
                    }

                    // 設定値読み取り
                    const setpointCommand = ModbusCommands.createReadSetpointCommand();
                    writer = port.writable.getWriter();
                    await writer.write(setpointCommand);
                    writer.releaseLock();

                    reader = port.readable.getReader();
                    const setpointResponse = await readWithTimeout(reader, 7, 1000);
                    reader.releaseLock();

                    if (setpointResponse[0] === 0x0B && setpointResponse[1] === 0x03) {
                        const setpoint = ((setpointResponse[3] << 8) | setpointResponse[4]) / 10;
                        document.getElementById('setpointValue').textContent = setpoint.toFixed(1);
                    }

                    document.getElementById('statusText').textContent = '通信OK';
                    await new Promise(resolve => setTimeout(resolve, updateIntervalMs));
                } catch (error) {
                    console.error('読み取りエラー:', error);
                    showDebugInfo('読み取りエラー: ' + error.message);
                    keepReading = false;
                }
            }
        }

        async function connectToPort() {
            try {
                port = await navigator.serial.requestPort();
                await port.open({
                    baudRate: 9600,
                    dataBits: 8,
                    stopBits: 1,
                    parity: 'none',
                });

                document.getElementById('statusText').textContent = '接続成功';
                document.getElementById('connectButton').textContent = '切断';
                document.getElementById('applySettings').disabled = false;
                document.getElementById('setTemp').disabled = false;
                document.getElementById('return25').disabled = false;
                document.getElementById('startTimer').disabled = false;
                
                startReading();
            } catch (error) {
                console.error('接続エラー:', error);
                document.getElementById('statusText').textContent = 'エラー: ' + error.message;
            }
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', () => {
            chartManager = new ChartManager('temperatureChart');
            timerManager = new TimerManager(
                document.getElementById('timerDisplay'),
                setTemperature
            );

            // 接続ボタン
            document.getElementById('connectButton').addEventListener('click', async () => {
                if (!port) {
                    await connectToPort();
                } else {
                    keepReading = false;
                    await port.close();
                    port = null;
                    document.getElementById('connectButton').textContent = '接続';
                    document.getElementById('statusText').textContent = '切断済み';
                    document.getElementById('temperatureValue').textContent = '--.-';
                    document.getElementById('setpointValue').textContent = '--.-';
                    document.getElementById('debugInfo').textContent = '';
                    document.getElementById('applySettings').disabled = true;
                    document.getElementById('setTemp').disabled = true;
                    document.getElementById('return25').disabled = true;
                    document.getElementById('startTimer').disabled = true;
                    document.getElementById('stopTimer').disabled = true;
                    chartManager.clear();
                }
            });

            // 設定適用ボタン
            document.getElementById('applySettings').addEventListener('click', () => {
                const intervalInput = document.getElementById('updateInterval');
                const newInterval = Math.max(1, Math.min(60, parseInt(intervalInput.value) || 1));
                intervalInput.value = newInterval;
                updateIntervalMs = newInterval * 1000;
                chartManager.setMaxPoints(Math.floor(3600 / newInterval));

                document.getElementById('statusText').textContent = 
                    `設定を更新しました（更新間隔: ${newInterval}秒, 表示期間: 60分）`;
            });

            // 温度設定ボタン
            document.getElementById('setTemp').addEventListener('click', () => {
                const temp = parseFloat(document.getElementById('tempSetpoint').value);
                if (!isNaN(temp) && temp >= 0 && temp <= 60) {
                    setTemperature(temp);
                } else {
                    alert('温度は0～60℃の範囲で入力してください');
                }
            });

            // 25℃復帰ボタン
            document.getElementById('return25').addEventListener('click', () => {
                setTemperature(25.0);
                document.getElementById('tempSetpoint').value = '25.0';
            });

            // タイマー開始ボタン
            document.getElementById('startTimer').addEventListener('click', () => {
                const duration = parseInt(document.getElementById('timerDuration').value);
                const targetTemp = parseFloat(document.getElementById('timerTemp').value);
                
                if (timerManager.startTimer(duration, targetTemp)) {
                    document.getElementById('stopTimer').disabled = false;
                    document.getElementById('startTimer').disabled = true;
                }
            });

            // タイマー停止ボタン
            document.getElementById('stopTimer').addEventListener('click', () => {
                timerManager.stopTimer();
                document.getElementById('stopTimer').disabled = true;
                document.getElementById('startTimer').disabled = false;
            });
        });
    </script>
</body>
</html>
